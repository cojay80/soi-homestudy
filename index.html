<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì†Œì´ì˜ ê³µë¶€ë°©</title>

  <!-- í°íŠ¸ / ê³µí†µ ìŠ¤íƒ€ì¼ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="css/style.css"/>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml"/>

  <!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ (ìˆœì„œ ìœ ì§€) -->
  <script src="/js/config.js" defer></script>
  <script src="/js/core-auth-store.js" defer></script>
  <script src="/js/api-shim.js" defer></script>

  <!-- í¬ì¸íŠ¸/ì¸ë²¤í† ë¦¬(ë¡œì»¬) -->
  <script src="/js/soi-store.js" defer></script>

  <!-- í—¤ë”/ë¡œê·¸ì•„ì›ƒ -->
  <script src="/js/logout.js?v=LOGOUT_FORCE_2" defer></script>
  <script src="/js/header.js?v=HDR_MINIMAL_3" defer></script>

  <!-- í™ˆ ì „ìš© (í•„ìš”ì‹œ) -->
  <!-- <script src="/js/home.js?v=HOME_1" defer></script> -->

  <style>
    .badge{padding:.2rem .5rem;border:1px solid #ddd;border-radius:999px;font-weight:600}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
    .card{border:1px solid #e5e5e5;border-radius:12px;padding:12px;background:#fff}
    .mini{color:#666;font-size:13px}
    .kpi{font-size:24px;font-weight:700}
    label.inline{display:flex;align-items:center;gap:8px}
    input[type=number], select{padding:8px;border:1px solid #ddd;border-radius:10px}
    button.btn{padding:10px 14px;border:1px solid #ddd;border-radius:12px;background:#fafafa;cursor:pointer}
    .cta{display:flex;gap:8px;flex-wrap:wrap}
    .quick{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:640px){ .quick{grid-template-columns:1fr} }
    .barwrap{background:#f3f3f3;border-radius:8px;overflow:hidden;height:12px}
    .bar{height:100%;background:#7aa6ff}
    .links{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .link-card{border:1px solid #e5e5e5;border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px;background:#fff}
    .link-card a{display:inline-block}

    /* í—¤ë” ì „ì²´ ì¤‘ì•™ ì •ë ¬ + ë³¸ë¬¸ í­ ë§ì¶¤ */
    :root { --page-width: 980px; }
    .main-header { background:#fff;border-bottom:1px solid #e5e5e5;padding:12px 16px; }
    .main-header > .logo,
    .main-header > .main-nav,
    .main-header > .user-info {
      max-width: var(--page-width);
      margin: 0 auto;
      text-align: center;
    }
    .main-header > .logo{ margin-bottom: 8px; }
    .main-header > .main-nav{ margin-bottom: 8px; }
    .main-nav ul{display:flex;justify-content:center;align-items:center;gap:18px;margin:0;padding:0;list-style:none}
    .main-nav a{display:inline-block;padding:8px 12px;border-radius:8px;color:#333;text-decoration:none;font-weight:600}
    .main-nav li.active a,.main-nav a:hover{background:#eef4ff;color:#1f3b8f}
    .user-info{display:flex;justify-content:center;align-items:center;gap:10px;color:#666}
    .mobile-menu-button{display:none}
  </style>
</head>
<body>
  <!-- ê³ ì • í—¤ë” -->
  <header class="main-header">
    <div class="logo">
      <a href="index.html">ì†Œì´ì˜ ê³µë¶€ë°© ğŸ¨</a>
    </div>
    <nav class="main-nav">
      <ul>
        <li class="active"><a href="index.html">ì˜¤ëŠ˜ì˜ í•™ìŠµ</a></li>
        <li><a href="report.html">í•™ìŠµ ë³´ê³ ì„œ</a></li>
        <li><a href="goal.html">ë‚˜ì˜ ëª©í‘œ</a></li>
        <li><a href="record.html">ìƒì„¸ ê¸°ë¡</a></li>
        <li><a href="notes.html">ì˜¤ë‹µ ë…¸íŠ¸</a></li>
        <li><a href="shop.html">ìƒì </a></li>
        <li><span class="badge">í¬ì¸íŠ¸: <b data-soi-points>0</b>p</span></li>
      </ul>
    </nav>
    <div class="user-info">
      <span id="welcome-message"></span>
      <a href="index.html?reset=1" id="logout-button">(ë¡œê·¸ì•„ì›ƒ)</a>
    </div>
    <button class="mobile-menu-button" aria-label="ë©”ë‰´ ì—´ê¸°">â˜°</button>
  </header>

  <!-- ë³¸ë¬¸ -->
  <main class="container" style="max-width:980px;margin:0 auto;padding:16px;">
    <h1>ì˜¤ëŠ˜ì˜ í•™ìŠµ âœ¨</h1>
    <p class="mini">í•™ë…„/ê³¼ëª©ì„ ê³ ë¥´ê³  ë°”ë¡œ ì‹œì‘! ì •ë‹µì„ ë§íˆë©´ í¬ì¸íŠ¸ì™€ ë³´ìƒì„ ì–»ì„ ìˆ˜ ìˆì–´ìš”.</p>

    <!-- ë¹ ë¥¸ ì‹œì‘ -->
    <section class="card" style="margin:12px 0;">
      <h2 style="margin:0 0 8px;">ë¹ ë¥¸ ì‹œì‘</h2>
      <div class="quick">
        <label class="inline">í•™ë…„
          <select id="sel-grade">
            <!-- ì‹œíŠ¸ì—ì„œ ë™ì  ì±„ì›€ -->
          </select>
        </label>
        <label class="inline">ê³¼ëª©
          <select id="sel-subject">
            <!-- ì‹œíŠ¸ì—ì„œ ë™ì  ì±„ì›€ -->
          </select>
        </label>
        <label class="inline">ì„¸íŠ¸ ìˆ˜(ì§€ë¬¸/ë‹¨ì¼ ë¬¶ìŒ)
          <input type="number" id="sel-count" min="1" step="1" value="10"/>
        </label>
        <label class="inline">ë¬¸í•­ íƒ€ì´ë¨¸(ì´ˆ, 0=ë¬´ì œí•œ)
          <input type="number" id="sel-timer" min="0" step="10" value="0"/>
        </label>
      </div>
      <div class="cta" style="margin-top:10px;">
        <button class="btn" id="btn-start">ì‹œì‘í•˜ê¸° â–¶</button>
        <button class="btn" id="btn-review" title="ì˜¤ë‹µì´ ìˆìœ¼ë©´ ë³µìŠµ ëª¨ë“œë¡œ ì´ë™">ì˜¤ë‹µ ë³µìŠµ</button>
        <a class="btn" href="shop.html">ìƒì  ê°€ê¸°</a>
      </div>
      <div id="home-msg" class="mini" style="margin-top:6px;color:#d33;"></div>
    </section>

    <!-- ì˜¤ëŠ˜ ì§„í–‰ -->
    <section class="grid" style="margin:12px 0;">
      <article class="card">
        <div class="mini">ì˜¤ëŠ˜ í‘¼ ë¬¸í•­</div>
        <div class="kpi"><span id="today-total">0</span></div>
        <div class="barwrap"><div id="bar-today" class="bar" style="width:0%"></div></div>
        <div class="mini">* ëª©í‘œ ëŒ€ë¹„ ì§„í–‰ë¥ ì€ <a href="goal.html">ë‚˜ì˜ ëª©í‘œ</a>ì—ì„œ í™•ì¸/ì„¤ì •</div>
      </article>
      <article class="card">
        <div class="mini">ì˜¤ëŠ˜ ì •ë‹µ ìˆ˜(=íšë“ í¬ì¸íŠ¸)</div>
        <div class="kpi"><span id="today-correct">0</span>p</div>
      </article>
      <article class="card">
        <div class="mini">ìµœê·¼ ì„¸ì…˜</div>
        <div id="recent-session" class="mini">â€”</div>
      </article>
    </section>

    <!-- ë°”ë¡œê°€ê¸° -->
    <section class="links" style="margin:12px 0;">
      <div class="link-card">
        <h3 style="margin:0;">í•™ìŠµ ë³´ê³ ì„œ</h3>
        <p class="mini">ìµœê·¼ 7ì¼ ì„±ê³¼ë¥¼ í•œëˆˆì—</p>
        <a class="btn" href="report.html">ë³´ê³ ì„œ ë³´ê¸°</a>
      </div>
      <div class="link-card">
        <h3 style="margin:0;">ì˜¤ë‹µ ë…¸íŠ¸</h3>
        <p class="mini">í‹€ë¦° ë¬¸ì œ ë³µìŠµ/ì •ë¦¬</p>
        <a class="btn" href="notes.html">ì˜¤ë‹µ ë³´ëŸ¬ê°€ê¸°</a>
      </div>
      <div class="link-card">
        <h3 style="margin:0;">ìƒì„¸ ê¸°ë¡</h3>
        <p class="mini">ëª¨ë“  ì„¸ì…˜ì„ í•„í„°/ì •ë ¬</p>
        <a class="btn" href="record.html">ê¸°ë¡ ê´€ë¦¬</a>
      </div>
      <div class="link-card">
        <h3 style="margin:0;">ìƒì </h3>
        <p class="mini">í¬ì¸íŠ¸ë¡œ ë³´ìƒì„ ë°›ì!</p>
        <a class="btn" href="shop.html">ìƒì ìœ¼ë¡œ</a>
      </div>
    </section>
  </main>

  <!-- í‘¸í„° -->
  <footer class="main-footer">
    <p>&copy; 2025 ì†Œì´ë¥¼ ìœ„í•œ ì•„ë¹ ì˜ ì„ ë¬¼</p>
  </footer>

  <!-- âœ… ì‹œíŠ¸ ê¸°ë°˜ ë™ì  ë“œë¡­ë‹¤ìš´ + ì‹œì‘/ë³µìŠµ ë¡œì§ -->
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const gradeSel = document.getElementById('sel-grade');
    const subjSel  = document.getElementById('sel-subject');
    const msgEl    = document.getElementById('home-msg');

    // ê¸°ë³¸ ì˜µì…˜ (ë¹„ì–´ìˆì„ ë•Œ ë©”ì‹œì§€ìš©)
    gradeSel.innerHTML = '<option value="">í•™ë…„ ì„ íƒ</option>';
    subjSel.innerHTML  = '<option value="">ê³¼ëª© ì„ íƒ</option>';

    // ===== 1) ì‹œíŠ¸ì—ì„œ ëª¨ë“  ë¬¸ì œ TSV ë°›ì•„ì˜¤ê¸° =====
    let text = '';
    try {
      if (!window.API || !window.API.problems) throw new Error('API.problems ë¯¸íƒ‘ì¬');
      text = await window.API.problems(); // config.jsì˜ GOOGLE_SHEET_TSV ìš°ì„ 
    } catch (e) {
      console.error('ë¬¸ì œ ë¡œë“œ ì‹¤íŒ¨:', e);
      msgEl.textContent = 'ë¬¸ì œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„·/ì‹œíŠ¸ ê³µê°œ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
      return;
    }

    // ===== 2) ê°„ë‹¨ íŒŒì‹±(íƒ­/ì‰¼í‘œ ìë™ ì²˜ë¦¬) =====
    const raw = String(text).replace(/\r\n/g,'\n').replace(/\r/g,'\n');
    const lines = raw.split('\n').filter(l=>l.trim().length>0);
    if (!lines.length) { msgEl.textContent='ì‹œíŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.'; return; }

    const head  = lines[0];
    const delim = (head.match(/\t/g)||[]).length >= (head.match(/,/g)||[]).length ? '\t' : ',';
    const H = head.split(delim).map(h=>h.trim());
    const norm = s => (s||'').toLowerCase().replace(/\s+/g,' ').trim();
    const gi = H.findIndex(h => ['í•™ë…„','grade'].includes(norm(h)));
    const si = H.findIndex(h => ['ê³¼ëª©','subject'].includes(norm(h)));
    if (gi < 0 || si < 0) { msgEl.textContent='í—¤ë”ì— "í•™ë…„/ê³¼ëª©" ì—´ì´ í•„ìš”í•©ë‹ˆë‹¤.'; return; }

    const grades = new Set();
    const subjectsByGrade = new Map();

    for (let i=1;i<lines.length;i++){
      const cols = lines[i].split(delim);
      const g = (cols[gi]||'').trim();
      const s = (cols[si]||'').trim();
      if(!g || !s) continue;
      grades.add(g);
      if(!subjectsByGrade.has(g)) subjectsByGrade.set(g, new Set());
      subjectsByGrade.get(g).add(s);
    }

    // ===== 3) í•™ë…„ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° =====
    const gradeList = [...grades].sort((a,b)=>a.localeCompare(b,'ko'));
    gradeSel.innerHTML = ['<option value="">í•™ë…„ ì„ íƒ</option>']
      .concat(gradeList.map(g=>`<option value="${g}">${g}</option>`)).join('');

    // ===== 4) í•™ë…„ì— ë”°ë¼ ê³¼ëª© ì±„ìš°ê¸° =====
    function fillSubjects(grade){
      const subs = subjectsByGrade.get(grade) ? [...subjectsByGrade.get(grade)] : [];
      subs.sort((a,b)=>a.localeCompare(b,'ko'));
      subjSel.innerHTML = ['<option value="">ê³¼ëª© ì„ íƒ</option>']
        .concat(subs.map(s=>`<option value="${s}">${s}</option>`)).join('');
    }
    gradeSel.addEventListener('change', ()=>{
      fillSubjects(gradeSel.value);
      localStorage.setItem('selectedGrade', gradeSel.value || '');
      localStorage.setItem('selectedSubject',''); // í•™ë…„ ë°”ë€Œë©´ ê³¼ëª© ì´ˆê¸°í™”
    });
    subjSel.addEventListener('change', ()=>{
      localStorage.setItem('selectedSubject', subjSel.value || '');
    });

    // ì´ì „ ì„ íƒ ë³µêµ¬
    const prevG = localStorage.getItem('selectedGrade');
    const prevS = localStorage.getItem('selectedSubject');
    if (prevG && gradeList.includes(prevG)) {
      gradeSel.value = prevG; fillSubjects(prevG);
      if (prevS) subjSel.value = prevS;
    } else {
      fillSubjects(gradeSel.value);
    }

    // ===== 5) ì‹œì‘ ë²„íŠ¼ =====
    document.getElementById('btn-start').addEventListener('click', () => {
      const g = gradeSel.value.trim();
      const s = subjSel.value.trim();
      const cnt = parseInt(document.getElementById('sel-count').value || '10', 10);
      const tmr = parseInt(document.getElementById('sel-timer').value || '0', 10);

      if (!g) { msgEl.textContent='í•™ë…„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'; return; }
      if (!s) { msgEl.textContent='ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'; return; }
      localStorage.setItem('selectedGrade', g);
      localStorage.setItem('selectedSubject', s);
      localStorage.setItem('selectedCount', String(Math.max(1, cnt)));
      localStorage.setItem('selectedTimer', String(Math.max(0, tmr)));

      // ì¼ë°˜ ëª¨ë“œ
      localStorage.removeItem('isReviewMode');
      localStorage.removeItem('reviewProblems');

      location.href = 'quiz.html';
    });

    // ===== 6) ì˜¤ë‹µ ë³µìŠµ =====
    document.getElementById('btn-review').addEventListener('click', () => {
      const user = localStorage.getItem('currentUser');
      try {
        const sd = JSON.parse(localStorage.getItem('studyData') || '{}');
        const wrongs = sd?.[user]?.incorrect || [];
        if (!wrongs.length) { msgEl.textContent = 'ì˜¤ë‹µì´ ì•„ì§ ì—†ì–´ìš”! ë¨¼ì € ë¬¸ì œë¥¼ í’€ì–´ë³´ì„¸ìš”.'; return; }
        localStorage.setItem('isReviewMode', 'true');
        localStorage.setItem('reviewProblems', JSON.stringify(wrongs));
        location.href = 'quiz.html';
      } catch {
        msgEl.textContent = 'ì˜¤ë‹µ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
      }
    });
  });
  </script>
</body>
</html>
