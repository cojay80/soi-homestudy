<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>μ†μ΄μ κ³µλ¶€λ°©</title>

  <!-- ν°νΈ / κ³µν†µ μ¤νƒ€μΌ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="./css/style.css"/>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml"/>

  <!-- κ³µν†µ μ¤ν¬λ¦½νΈ (defer μμ„ κ³ μ •) -->
  <script src="/js/config.js" defer></script>
  <script src="/js/core-auth-store.js" defer></script>
  <script src="/js/api-shim.js" defer></script>
  <script src="/js/soi-store.js" defer></script>
  <script src="/js/header.js" defer></script>
  <script src="/js/logout.js" defer></script>
</head>
<body>
  <!-- ν—¤λ” -->
  <header class="main-header">
    <div class="logo"><a href="index.html">μ†μ΄μ κ³µλ¶€λ°© π¨</a></div>

    <nav class="main-nav">
      <ul>
        <li class="active"><a href="index.html">μ¤λμ ν•™μµ</a></li>
        <li><a href="report.html">ν•™μµ λ³΄κ³ μ„</a></li>
        <li><a href="goal.html">λ‚μ λ©ν‘</a></li>
        <li><a href="record.html">μƒμ„Έ κΈ°λ΅</a></li>
        <li><a href="notes.html">μ¤λ‹µ λ…ΈνΈ</a></li>
        <li><a href="shop.html">μƒμ </a></li>
        <li><span class="badge">ν¬μΈνΈ: <b data-soi-points>0</b>p</span></li>
      </ul>
    </nav>

    <div class="user-info">
      <span id="welcome-message"></span>
      <button id="logout-button" type="button" aria-label="λ΅κ·Έμ•„μ›ƒ" style="display:none">λ΅κ·Έμ•„μ›ƒ</button>
    </div>

    <button class="mobile-menu-button" aria-label="λ©”λ‰΄ μ—΄κΈ°">β°</button>
  </header>

  <!-- λ³Έλ¬Έ -->
  <main class="container">
    <h1>μ¤λμ ν•™μµ β¨</h1>
    <p class="mini">ν•™λ…„/κ³Όλ©μ„ κ³ λ¥΄κ³  λ°”λ΅ μ‹μ‘! μ •λ‹µμ„ λ§νλ©΄ ν¬μΈνΈμ™€ λ³΄μƒμ„ μ–»μ„ μ μμ–΄μ”.</p>

    <!-- λΉ λ¥Έ μ‹μ‘ -->
    <section class="card">
      <h2 style="margin:0 0 8px;">λΉ λ¥Έ μ‹μ‘</h2>
      <div class="quick" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <label class="inline">ν•™λ…„
          <select id="sel-grade"><option value="">ν•™λ…„ μ„ νƒ</option></select>
        </label>
        <label class="inline">κ³Όλ©
          <select id="sel-subject"><option value="">κ³Όλ© μ„ νƒ</option></select>
        </label>
        <label class="inline">μ„ΈνΈ μ(μ§€λ¬Έ/λ‹¨μΌ λ¬¶μ)
          <input type="number" id="sel-count" min="1" step="1" value="10"/>
        </label>
        <label class="inline">λ¬Έν•­ νƒ€μ΄λ¨Έ(μ΄, 0=λ¬΄μ ν•)
          <input type="number" id="sel-timer" min="0" step="10" value="0"/>
        </label>
      </div>
      <div class="cta" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="btn-start">μ‹μ‘ν•κΈ° β–¶</button>
        <button class="btn" id="btn-review" title="μ¤λ‹µμ΄ μμΌλ©΄ λ³µμµ λ¨λ“λ΅ μ΄λ™">μ¤λ‹µ λ³µμµ</button>
        <a class="btn" href="shop.html">μƒμ  κ°€κΈ°</a>
      </div>
      <div id="home-msg" class="mini" style="margin-top:6px;color:#d33;"></div>
    </section>

    <!-- μ¤λ μ§„ν–‰ -->
    <section class="grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px">
      <article class="card">
        <div class="mini">μ¤λ ν‘Ό λ¬Έν•­</div>
        <div class="kpi"><span id="today-total">0</span></div>
        <div class="barwrap"><div id="bar-today" class="bar" style="width:0%"></div></div>
        <div class="mini">* λ©ν‘ λ€λΉ„ μ§„ν–‰λ¥ μ€ <a href="goal.html">λ‚μ λ©ν‘</a>μ—μ„ ν™•μΈ/μ„¤μ •</div>
      </article>
      <article class="card">
        <div class="mini">μ¤λ μ •λ‹µ μ(=νλ“ ν¬μΈνΈ)</div>
        <div class="kpi"><span id="today-correct">0</span>p</div>
      </article>
      <article class="card">
        <div class="mini">μµκ·Ό μ„Έμ…</div>
        <div id="recent-session" class="mini">β€”</div>
      </article>
    </section>

    <!-- λ°”λ΅κ°€κΈ° -->
    <section class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
      <div class="card">
        <h3 style="margin:0;">ν•™μµ λ³΄κ³ μ„</h3>
        <p class="mini">μµκ·Ό 7μΌ μ„±κ³Όλ¥Ό ν•λμ—</p>
        <a class="btn" href="report.html">λ³΄κ³ μ„ λ³΄κΈ°</a>
      </div>
      <div class="card">
        <h3 style="margin:0;">μ¤λ‹µ λ…ΈνΈ</h3>
        <p class="mini">ν‹€λ¦° λ¬Έμ  λ³µμµ/μ •λ¦¬</p>
        <a class="btn" href="notes.html">μ¤λ‹µ λ³΄λ¬κ°€κΈ°</a>
      </div>
      <div class="card">
        <h3 style="margin:0;">μƒμ„Έ κΈ°λ΅</h3>
        <p class="mini">λ¨λ“  μ„Έμ…μ„ ν•„ν„°/μ •λ ¬</p>
        <a class="btn" href="record.html">κΈ°λ΅ κ΄€λ¦¬</a>
      </div>
      <div class="card">
        <h3 style="margin:0;">μƒμ </h3>
        <p class="mini">ν¬μΈνΈλ΅ λ³΄μƒμ„ λ°›μ!</p>
        <a class="btn" href="shop.html">μƒμ μΌλ΅</a>
      </div>
    </section>
  </main>

  <!-- ν‘Έν„° -->
  <footer class="main-footer">
    <p>&copy; 2025 μ†μ΄λ¥Ό μ„ν• μ•„λΉ μ μ„ λ¬Ό</p>
  </footer>

  <!-- ν™ μ „μ© μ¤ν¬λ¦½νΈ: μ‹νΈμ—μ„ ν•™λ…„/κ³Όλ© μ±„μ°κΈ° & μ‹μ‘/λ³µμµ -->
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const gradeSel = document.getElementById('sel-grade');
    const subjSel  = document.getElementById('sel-subject');
    const msgEl    = document.getElementById('home-msg');

    let text = '';
    try {
      if (!window.API || !window.API.problems) throw new Error('API.problems λ―Ένƒ‘μ¬');
      text = await window.API.problems();
    } catch (e) {
      console.error('λ¬Έμ  λ΅λ“ μ‹¤ν¨:', e);
      msgEl.textContent = 'λ¬Έμ  λ©λ΅μ„ λ¶λ¬μ¤μ§€ λ»ν–μµλ‹λ‹¤. μΈν„°λ„·/μ‹νΈ κ³µκ° μƒνƒλ¥Ό ν™•μΈν•΄μ£Όμ„Έμ”.';
      return;
    }

    const raw = String(text).replace(/\r\n/g,'\n').replace(/\r/g,'\n');
    const lines = raw.split('\n').filter(l=>l.trim().length>0);
    if (!lines.length) { msgEl.textContent='μ‹νΈκ°€ λΉ„μ–΄ μμµλ‹λ‹¤.'; return; }

    const head  = lines[0];
    const delim = (head.match(/\t/g)||[]).length >= (head.match(/,/g)||[]).length ? '\t' : ',';
    const H = head.split(delim).map(h=>h.trim());
    const norm = s => (s||'').toLowerCase().replace(/\s+/g,' ').trim();
    const gi = H.findIndex(h => ['ν•™λ…„','grade'].includes(norm(h)));
    const si = H.findIndex(h => ['κ³Όλ©','subject'].includes(norm(h)));
    if (gi < 0 || si < 0) { msgEl.textContent='ν—¤λ”μ— "ν•™λ…„/κ³Όλ©" μ—΄μ΄ ν•„μ”ν•©λ‹λ‹¤.'; return; }

    const grades = new Set();
    const subjectsByGrade = new Map();

    for (let i=1;i<lines.length;i++){
      const cols = lines[i].split(delim);
      const g = (cols[gi]||'').trim();
      const s = (cols[si]||'').trim();
      if(!g || !s) continue;
      grades.add(g);
      if(!subjectsByGrade.has(g)) subjectsByGrade.set(g, new Set());
      subjectsByGrade.get(g).add(s);
    }

    const gradeList = [...grades].sort((a,b)=>a.localeCompare(b,'ko'));
    gradeSel.innerHTML = ['<option value="">ν•™λ…„ μ„ νƒ</option>']
      .concat(gradeList.map(g=>`<option value="${g}">${g}</option>`)).join('');

    function fillSubjects(grade){
      const subs = subjectsByGrade.get(grade) ? [...subjectsByGrade.get(grade)] : [];
      subs.sort((a,b)=>a.localeCompare(b,'ko'));
      subjSel.innerHTML = ['<option value="">κ³Όλ© μ„ νƒ</option>']
        .concat(subs.map(s=>`<option value="${s}">${s}</option>`)).join('');
    }

    gradeSel.addEventListener('change', ()=>{
      fillSubjects(gradeSel.value);
      localStorage.setItem('selectedGrade', gradeSel.value || '');
      localStorage.setItem('selectedSubject','');
    });
    subjSel.addEventListener('change', ()=>{
      localStorage.setItem('selectedSubject', subjSel.value || '');
    });

    const prevG = localStorage.getItem('selectedGrade');
    const prevS = localStorage.getItem('selectedSubject');
    if (prevG && gradeList.includes(prevG)) {
      gradeSel.value = prevG; fillSubjects(prevG);
      if (prevS) subjSel.value = prevS;
    } else {
      fillSubjects(gradeSel.value);
    }

    document.getElementById('btn-start').addEventListener('click', () => {
      const g = (gradeSel.value || '').trim();
      const s = (subjSel.value  || '').trim();
      const cnt = parseInt(document.getElementById('sel-count').value || '10', 10);
      const tmr = parseInt(document.getElementById('sel-timer').value || '0', 10);
      if (!g) { msgEl.textContent='ν•™λ…„μ„ μ„ νƒν•΄μ£Όμ„Έμ”.'; return; }
      if (!s) { msgEl.textContent='κ³Όλ©μ„ μ„ νƒν•΄μ£Όμ„Έμ”.'; return; }
      localStorage.setItem('selectedGrade', g);
      localStorage.setItem('selectedSubject', s);
      localStorage.setItem('selectedCount', String(Math.max(1, cnt)));
      localStorage.setItem('selectedTimer', String(Math.max(0, tmr)));
      localStorage.removeItem('isReviewMode');
      localStorage.removeItem('reviewProblems');
      location.href = 'quiz.html';
    });

    document.getElementById('btn-review').addEventListener('click', () => {
      const user = localStorage.getItem('currentUser') || 'soi';
      try {
        const sd = JSON.parse(localStorage.getItem('studyData') || '{}');
        const wrongs = sd?.[user]?.incorrect || [];
        if (!wrongs.length) { msgEl.textContent = 'μ¤λ‹µμ΄ μ•„μ§ μ—†μ–΄μ”! λ¨Όμ € λ¬Έμ λ¥Ό ν’€μ–΄λ³΄μ„Έμ”.'; return; }
        localStorage.setItem('isReviewMode', 'true');
        localStorage.setItem('reviewProblems', JSON.stringify(wrongs));
        location.href = 'quiz.html';
      } catch {
        msgEl.textContent = 'μ¤λ‹µ λ°μ΄ν„°λ¥Ό λ¶λ¬μ¤μ§€ λ»ν–μµλ‹λ‹¤.';
      }
    });
  });
  </script>

  <!-- ν—¤λ”: ν–„λ²„κ±° λ“λ΅μ› ν† κΈ€ (κ³µμ©, νμ΄μ§€λ‹Ή 1νλ§) -->
  <script>
  (function(){
    const btn = document.querySelector('.mobile-menu-button');
    const nav = document.querySelector('.main-header .main-nav');
    function close(){ document.body.classList.remove('nav-open'); }
    if (btn && nav) {
      btn.addEventListener('click', () => {
        document.body.classList.toggle('nav-open');
      });
      nav.addEventListener('click', (e) => { if (e.target.closest('a')) close(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });
    }
  })();
  </script>
</body>
</html>
