// js/quiz.js ‚Äî ÏµúÏ¢ÖÎ≥∏ (saveUserData Ìò∏Ï∂úÎ°ú ÏàòÏ†ï + ÏïàÏ†ïÏÑ± Î≥¥Í∞ï)
//
// - Î¨∏Ï†ú Î°úÎìú: window.API.problems() ‚Üí CONFIG.GOOGLE_SHEET_TSV ÏßÅÍ≤∞ ÎòêÎäî /api/problems
// - Ìè¨Ïù∏Ìä∏/Î≥¥ÏÉÅ: Ï†ïÎãµÎãπ +CONFIG.POINTS_PER_CORRECT, ÎûúÎç§ Î≥¥ÏÉÅ(ÏÜåÌòï/ÎåÄÌòï)
// - Î≥µÏäµ Î™®Îìú: localStorage.isReviewMode / reviewProblems
// - Í≤∞Í≥º Ï†ÄÏû•: window.API.saveUserData(currentUser, myData) (Ïã§Ìå®Ìï¥ÎèÑ Î°úÏª¨ Ïú†ÏßÄ)

document.addEventListener('DOMContentLoaded', () => {
  // ----- DOM ÌõÖ -----
  const questionText   = document.querySelector('.question-text');
  const answerOptions  = document.querySelectorAll('.option');
  const progress       = document.querySelector('.progress');
  const questionNumber = document.querySelector('.question-number');
  const toastMessage   = document.getElementById('toast-message');
  const timerDisplay   = document.getElementById('timer-display');
  const questionImage  = document.getElementById('question-image');
  const quizLayout     = document.querySelector('.quiz-layout');
  const resultsContainer = document.getElementById('results-container');
  const passageArea    = document.querySelector('.passage-area');
  const passageContent = document.getElementById('passage-content');
  const problemArea    = document.querySelector('.problem-area');

  // ----- ÌôòÍ≤Ω/ÏÉÅÌÉú -----
  const CONFIG = window.CONFIG || {};
  const API    = window.API || {};
  const currentUser     = localStorage.getItem('currentUser') || (window.getCurrentUser && window.getCurrentUser()) || 'soi';
  const selectedGrade   = localStorage.getItem('selectedGrade');
  const selectedSubject = localStorage.getItem('selectedSubject');
  const selectedCount   = parseInt(localStorage.getItem('selectedCount') || '10', 10);
  const selectedTimer   = parseInt(localStorage.getItem('selectedTimer') || '0', 10);
  const isReviewMode    = localStorage.getItem('isReviewMode') === 'true';

  let studyData = safeJSON(localStorage.getItem('studyData')) || {};
  if (!studyData[currentUser]) studyData[currentUser] = { incorrect: [], records: [] };

  let problemSets = [];                 // [{type:'single'|'passage', questions:[...]}]
  let currentProblemSetIndex = 0;       // ÌòÑÏû¨ ÏÑ∏Ìä∏ Ïù∏Îç±Ïä§
  let currentQuestionInSetIndex = 0;    // ÏÑ∏Ìä∏ ÎÇ¥ Î¨∏Ï†ú Ïù∏Îç±Ïä§
  let score = 0;
  let incorrectProblems = [];
  let isAnswered = false;
  let timerInterval;

  // ===== Î°úÏª¨ Ïä§ÌÜ†Ïñ¥ Fallback Ïú†Ìã∏ =====
  const KEYS = { POINTS:'soi:points', INVENTORY:'soi:inventory' };
  const poiGet = window.soi_pointsGet || (() => Number(localStorage.getItem(KEYS.POINTS) || '0'));
  const poiAdd = window.soi_pointsAdd || ((delta) => {
    const v = poiGet() + Number(delta || 0);
    localStorage.setItem(KEYS.POINTS, String(v));
    document.querySelectorAll('[data-soi-points]').forEach(el => (el.textContent = v));
    window.dispatchEvent(new Event('points:changed'));
    return v;
  });
  const invGet = window.soi_inventoryGet || (() => safeJSON(localStorage.getItem(KEYS.INVENTORY)) || {});
  const invSet = window.soi_inventorySet || ((o) => localStorage.setItem(KEYS.INVENTORY, JSON.stringify(o || {})));

  // ===== Ï†ïÎãµ Î≥¥ÏÉÅ(ÏïàÏ†Ñ) =====
  async function awardOnCorrectSafe() {
    try {
      if (window.SOI_awardOnCorrect && typeof window.SOI_awardOnCorrect === 'function') {
        await window.SOI_awardOnCorrect();
        return;
      }
    } catch (e) {
      console.warn('[awardOnCorrectSafe] custom award skipped:', e);
    }
    const per = Number(CONFIG.POINTS_PER_CORRECT || 1);
    poiAdd(per);

    const smallRate = Number(CONFIG?.REWARD?.SMALL_RATE || 0.25);
    const bigRate   = Number(CONFIG?.REWARD?.BIG_RATE   || 0.01);
    const smallId   = (CONFIG?.REWARD?.SMALL_ITEM_ID) || 'sticker_star';
    const bigId     = (CONFIG?.REWARD?.BIG_ITEM_ID)   || 'badge_gold';

    const r = Math.random();
    const inv = invGet();
    if (r < bigRate) {
      inv[bigId] = true; // ÏÜåÏû•Ìòï
    } else if (r < smallRate + bigRate) {
      inv[smallId] = (inv[smallId] || 0) + 1; // ÏÜåÎ™®Ìòï +1
    }
    invSet(inv);
  }

  // ===== Ï¥àÍ∏∞ ÏßÑÏûÖ =====
  async function setupQuiz() {
    if (isReviewMode) {
      const reviewProblems = safeJSON(localStorage.getItem('reviewProblems')) || [];
      if (!reviewProblems.length) {
        alert('Î≥µÏäµÌï† Ïò§Îãµ Î¨∏Ï†úÍ∞Ä ÏóÜÏäµÎãàÎã§. Î©îÏù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ëÎãàÎã§.');
        localStorage.removeItem('isReviewMode');
        localStorage.removeItem('reviewProblems');
        location.href = 'index.html';
        return;
      }
      problemSets = groupProblems(reviewProblems);
      loadProblem();
      return;
    }

    if (!selectedGrade || !selectedSubject) {
      alert('Î®ºÏ†Ä ÌïôÎÖÑÍ≥º Í≥ºÎ™©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!');
      location.href = 'index.html';
      return;
    }

    try {
      const tsvText = await (API.problems ? API.problems() : fetchProblemsFallback());
      const allProblems = parseTsv(tsvText);
      const filtered = allProblems.filter(p => (p.ÌïôÎÖÑ === selectedGrade && p.Í≥ºÎ™© === selectedSubject));

      problemSets = groupProblems(filtered)
        .sort(() => Math.random() - 0.5)
        .slice(0, selectedCount);

      if (!problemSets.length) {
        showMessage(`ÏÑ†ÌÉùÌïòÏã† '${selectedGrade} ${selectedSubject}'Ïóê Ìï¥ÎãπÌïòÎäî Î¨∏Ï†úÍ∞Ä ÏóÜÏäµÎãàÎã§.`);
        return;
      }
      loadProblem();
    } catch (err) {
      console.error('Î¨∏Ï†úÎ•º Í∞ÄÏ†∏Ïò§Îäî Îç∞ Ïã§Ìå®:', err);
      showMessage('Î¨∏Ï†úÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏñ¥Ïöî. Ïù∏ÌÑ∞ÎÑ∑/ÏãúÌä∏ Í≥µÍ∞ú ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî!');
    }
  }

  function fetchProblemsFallback() {
    return fetch('/api/problems', { headers: { 'Cache-Control': 'no-cache' }})
      .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.text(); });
  }

  // ===== ÏßÄÎ¨∏ Î¨∂Ïùå Íµ¨ÏÑ± =====
  function groupProblems(problems) {
    const grouped = [];
    const passageMap = new Map();
    if (!Array.isArray(problems)) return grouped;

    problems.forEach(p => {
      const pid = (p['ÏßÄÎ¨∏ ID'] || '').trim();
      if (pid) {
        if (!passageMap.has(pid)) passageMap.set(pid, []);
        passageMap.get(pid).push(p);
      } else {
        grouped.push({ type:'single', questions:[p] });
      }
    });
    passageMap.forEach((list) => grouped.push({ type:'passage', questions:list }));
    return grouped;
  }

  // ===== Ìïú Î¨∏Ï†ú ÏÑ∏Ìä∏ Î°úÎìú =====
  function loadProblem() {
    isAnswered = false;
    clearInterval(timerInterval);
    if (timerDisplay) timerDisplay.textContent = '';

    answerOptions.forEach(btn => btn.classList.remove('correct-answer', 'incorrect-answer', 'selected'));

    const currentSet = problemSets[currentProblemSetIndex];
    const currentQ   = currentSet.questions[currentQuestionInSetIndex];

    // ÏßÄÎ¨∏
    if (currentSet.type === 'passage') {
      if (passageArea) passageArea.style.display = 'block';
      if (problemArea) problemArea.style.width = '60%';
      if (currentQuestionInSetIndex === 0 && passageContent) {
        passageContent.textContent = currentSet.questions[0]['ÏßÄÎ¨∏'] || '';
      }
    } else {
      if (passageArea) passageArea.style.display = 'none';
      if (problemArea) problemArea.style.width = '100%';
    }

    // Ïù¥ÎØ∏ÏßÄ
    if (questionImage) {
      if (currentQ.Ïù¥ÎØ∏ÏßÄ && currentQ.Ïù¥ÎØ∏ÏßÄ.trim() !== '') {
        questionImage.src = currentQ.Ïù¥ÎØ∏ÏßÄ;
        questionImage.style.display = 'block';
      } else {
        questionImage.style.display = 'none';
      }
    }

    // ÏßàÎ¨∏/Î≥¥Í∏∞
    if (questionText) questionText.textContent = `[${currentQ.Í≥ºÎ™©}] ${currentQ.ÏßàÎ¨∏}`;
    const options = [currentQ.Î≥¥Í∏∞1, currentQ.Î≥¥Í∏∞2, currentQ.Î≥¥Í∏∞3, currentQ.Î≥¥Í∏∞4]
      .filter(Boolean)
      .sort(() => Math.random() - 0.5);

    for (let i=0; i<answerOptions.length; i++) {
      answerOptions[i].textContent = options[i] || '';
    }

    // ÏßÑÌñâÎèÑ
    const totalQuestions = problemSets.reduce((sum, set) => sum + set.questions.length, 0);
    const solvedSoFar = problemSets.slice(0, currentProblemSetIndex)
      .reduce((s, set) => s + set.questions.length, 0) + currentQuestionInSetIndex + 1;

    if (questionNumber) questionNumber.textContent = `${solvedSoFar} / ${totalQuestions}`;
    if (progress) progress.style.width = `${(solvedSoFar / totalQuestions) * 100}%`;

    // ÌÉÄÏù¥Î®∏
    if (selectedTimer > 0 && !isReviewMode) startTimer(selectedTimer);
  }

  // ===== Î≥¥Í∏∞ ÌÅ¥Î¶≠ =====
  answerOptions.forEach(btn => {
    btn.addEventListener('click', async (e) => {
      if (isAnswered) return;
      const label = (e.target.textContent || '').trim();
      if (!label) return; // Îπà Î≥¥Í∏∞ ÌÅ¥Î¶≠ Î¨¥Ïãú
      isAnswered = true;
      clearInterval(timerInterval);

      const currentQ = problemSets[currentProblemSetIndex].questions[currentQuestionInSetIndex];
      const isCorrect = (label === String(currentQ.Ï†ïÎãµ || '').trim());

      if (isCorrect) {
        score++;
        e.target.classList.add('correct-answer');
        showToast('Ï†ïÎãµÏûÖÎãàÎã§! üéâ', true);
        await awardOnCorrectSafe();
      } else {
        incorrectProblems.push(currentQ);
        e.target.classList.add('incorrect-answer');
        answerOptions.forEach(b => {
          if ((b.textContent || '').trim() === String(currentQ.Ï†ïÎãµ || '').trim()) {
            b.classList.add('correct-answer');
          }
        });
        showToast('ÏïÑÏâ¨ÏõåÏöî, Îã§Ïùå Î¨∏Ï†úÎ°ú ÎÑòÏñ¥Í∞ëÎãàÎã§.', false);
      }
      setTimeout(goToNextQuestion, 1500);
    });
  });

  function goToNextQuestion() {
    const curSet = problemSets[currentProblemSetIndex];
    if (currentQuestionInSetIndex < curSet.questions.length - 1) {
      currentQuestionInSetIndex++;
      loadProblem();
      return;
    }
    currentProblemSetIndex++;
    currentQuestionInSetIndex = 0;
    if (currentProblemSetIndex < problemSets.length) {
      loadProblem();
    } else {
      showResults();
    }
  }

  // ===== Í≤∞Í≥º =====
  async function showResults() {
    if (quizLayout) quizLayout.style.display = 'none';
    if (resultsContainer) resultsContainer.style.display = 'block';

    const scoreText   = document.getElementById('score-text');
    const messageText = document.getElementById('message-text');
    const reviewButton= document.getElementById('review-button');
    const mainMenuBtn = document.getElementById('main-menu-button');

    const totalQuestions = problemSets.reduce((sum, set) => sum + set.questions.length, 0);

    // Í∏∞Î°ù(Î≥µÏäµ Ï†úÏô∏)
    if (!isReviewMode && totalQuestions > 0) {
      const today = new Date();
      const dateString = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      const newRec = { date: dateString, grade: selectedGrade, subject: selectedSubject, score: `${score}/${totalQuestions}` };
      if (!studyData[currentUser]) studyData[currentUser] = { incorrect: [], records: [] };
      if (!Array.isArray(studyData[currentUser].records)) studyData[currentUser].records = [];
      studyData[currentUser].records.push(newRec);
    }

    // Ïò§Îãµ(Î≥µÏäµ Ï†úÏô∏)
    if (!isReviewMode && incorrectProblems.length > 0) {
      if (!Array.isArray(studyData[currentUser].incorrect)) studyData[currentUser].incorrect = [];
      const map = new Map(studyData[currentUser].incorrect.map(p => [p.ÏßàÎ¨∏, p]));
      incorrectProblems.forEach(p => map.set(p.ÏßàÎ¨∏, p));
      studyData[currentUser].incorrect = Array.from(map.values());
    }

    // Î≥µÏäµ Î™®ÎìúÏóêÏÑú ÌíÄÏñ¥ÎÇ∏ Î¨∏Ï†úÎäî Ïò§ÎãµÏóêÏÑú Ï†úÍ±∞
    if (isReviewMode) {
      const solvedQuestions = problemSets.flatMap(set => set.questions).map(q => q.ÏßàÎ¨∏);
      if (studyData[currentUser]) {
        studyData[currentUser].incorrect = (studyData[currentUser].incorrect || []).filter(p => !solvedQuestions.includes(p.ÏßàÎ¨∏));
      }
      localStorage.removeItem('isReviewMode');
      localStorage.removeItem('reviewProblems');
    }

    // Ï†ÄÏû• ÏãúÎèÑ (ÏÑúÎ≤Ñ Ïã§Ìå®Ìï¥ÎèÑ Î°úÏª¨ Ïú†ÏßÄ) ‚Äî ‚úÖ saveUserDataÎ°ú ÏàòÏ†ï
    try {
      const myData = studyData[currentUser] || {};
      if (API.saveUserData) {
        await API.saveUserData(currentUser, myData);
      } else {
        await fetch(`/api/data/${encodeURIComponent(currentUser)}`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(myData)
        });
      }
    } catch (e) {
      console.warn('Í≤∞Í≥º Ï†ÄÏû• Ïã§Ìå®(Î°úÏª¨ÏùÄ Ïú†ÏßÄ):', e);
    } finally {
      // Î°úÏª¨ Î∞±ÏóÖ ÏóÖÎç∞Ïù¥Ìä∏
      localStorage.setItem('studyData', JSON.stringify(studyData));
      // Î≤ÑÌäº/Î≥µÏäµ ÏÉÅÌÉú
      if (mainMenuBtn) {
        mainMenuBtn.textContent = 'Î©îÏù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞';
        mainMenuBtn.classList.remove('disabled-link');
      }

      const savedIncorrect = studyData[currentUser]?.incorrect || [];
      if (reviewButton) {
        if (savedIncorrect.length > 0 && !isReviewMode) {
          reviewButton.textContent = 'ÌãÄÎ¶∞ Î¨∏Ï†ú Îã§Ïãú ÌíÄÍ∏∞';
          reviewButton.disabled = false;
          reviewButton.addEventListener('click', () => {
            const wrongs = studyData[currentUser]?.incorrect || [];
            if (!wrongs.length) return;
            localStorage.setItem('isReviewMode', 'true');
            localStorage.setItem('reviewProblems', JSON.stringify(wrongs));
            location.href = 'quiz.html';
          });
        } else {
          reviewButton.style.display = 'none';
        }
      }
      if (mainMenuBtn) mainMenuBtn.addEventListener('click', () => location.href = 'index.html');
    }

    // Î©îÏãúÏßÄ
    if (scoreText) {
      scoreText.textContent = `Ï¥ù ${totalQuestions}Î¨∏Ï†ú Ï§ë ${score}Í∞úÎ•º ÎßûÌòîÏñ¥Ïöî!`;
    }
    const pct = totalQuestions > 0 ? (score / totalQuestions) * 100 : 100;
    if (messageText) {
      if (pct >= 80) messageText.textContent = 'Ï†ïÎßê ÎåÄÎã®Ìï¥Ïöî! ÌõåÎ•≠Ìïú Ïã§Î†•Ïù¥ÏóêÏöî. üèÜ';
      else if (pct >= 50) messageText.textContent = 'ÏûòÌñàÏñ¥Ïöî! Ï°∞Í∏àÎßå Îçî ÎÖ∏Î†•Ìï¥Î¥êÏöî. üòä';
      else messageText.textContent = 'ÏïÑÏâ¨ÏõåÏöî, Îã§Ïãú ÌïúÎ≤à ÎèÑÏ†ÑÌï¥Î≥ºÍπåÏöî? üí™';
    }
  }

  // ===== ÌÉÄÏù¥Î®∏ =====
  function startTimer(seconds) {
    let timeLeft = seconds;
    if (timerDisplay) timerDisplay.textContent = `ÎÇ®ÏùÄ ÏãúÍ∞Ñ: ${timeLeft}Ï¥à`;
    timerInterval = setInterval(() => {
      timeLeft--;
      if (timerDisplay) timerDisplay.textContent = `ÎÇ®ÏùÄ ÏãúÍ∞Ñ: ${timeLeft}Ï¥à`;
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        isAnswered = true;
        const currentQ = problemSets[currentProblemSetIndex].questions[currentQuestionInSetIndex];
        incorrectProblems.push(currentQ);
        showToast('ÏãúÍ∞Ñ Ï¥àÍ≥º!', false);
        setTimeout(goToNextQuestion, 1200);
      }
    }, 1000);
  }

  // ===== Î©îÏãúÏßÄ/ÌÜ†Ïä§Ìä∏ =====
  function showMessage(msg) {
    if (questionText) questionText.textContent = msg;
  }
  function showToast(message, isCorrect) {
    if (!toastMessage) return;
    toastMessage.textContent = message;
    toastMessage.className = isCorrect ? 'correct' : 'incorrect';
    toastMessage.classList.add('show');
    setTimeout(() => toastMessage.classList.remove('show'), Number(CONFIG?.UI?.SHOW_TOAST_MS || 1500));
  }

  // ===== ÏïàÏ†Ñ JSON =====
  function safeJSON(s) { try { return JSON.parse(s || ''); } catch { return null; } }

  // ===== TSV/CSV ÌååÏÑú =====
  function parseTsv(text) {
    if (!text) return [];
    const raw = String(text).replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    const lines = raw.split('\n').filter(l => l.trim().length > 0);
    if (!lines.length) return [];

    // Íµ¨Î∂ÑÏûê ÏûêÎèô(ÌÉ≠ Ïö∞ÏÑ†)
    const firstLine = lines[0];
    const tabCount = (firstLine.match(/\t/g) || []).length;
    const commaCount = (firstLine.match(/,/g) || []).length;
    const delim = tabCount >= commaCount ? '\t' : ',';

    // Îî∞Ïò¥Ìëú Ï≤òÎ¶¨ Ïä§ÌîåÎ¶¨ÌÑ∞
    function splitSmart(line) {
      const out = [];
      let buf = '', inQ = false;
      for (let i=0; i<line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQ && line[i+1] === '"') { buf += '"'; i++; }
          else inQ = !inQ;
        } else if (ch === delim && !inQ) {
          out.push(buf); buf = '';
        } else {
          buf += ch;
        }
      }
      out.push(buf);
      return out;
    }

    // Ìó§Îçî Îß§Ìïë
    const headers = splitSmart(lines[0]).map(h => (h || '').replace(/\s+/g, ' ').trim());
    const wanted = ['ÌïôÎÖÑ','Í≥ºÎ™©','ÏßàÎ¨∏','Î≥¥Í∏∞1','Î≥¥Í∏∞2','Î≥¥Í∏∞3','Î≥¥Í∏∞4','Ï†ïÎãµ','Ïù¥ÎØ∏ÏßÄ','ÏßÄÎ¨∏ ID','ÏßÄÎ¨∏'];
    const alias = {
      'ÏßÄÎ¨∏ID':'ÏßÄÎ¨∏ ID','ÏßÄÎ¨∏id':'ÏßÄÎ¨∏ ID','passage id':'ÏßÄÎ¨∏ ID','passage':'ÏßÄÎ¨∏',
      'grade':'ÌïôÎÖÑ','subject':'Í≥ºÎ™©','question':'ÏßàÎ¨∏','answer':'Ï†ïÎãµ','image':'Ïù¥ÎØ∏ÏßÄ',
      'option1':'Î≥¥Í∏∞1','option2':'Î≥¥Í∏∞2','option3':'Î≥¥Í∏∞3','option4':'Î≥¥Í∏∞4'
    };
    const norm = s => (s||'').toLowerCase().replace(/\s+/g,' ').trim();

    const headerMap = {};
    headers.forEach((h, idx) => {
      const hNorm = norm(h);
      let key = wanted.find(w => norm(w) === hNorm);
      if (!key) {
        const ali = Object.entries(alias).find(([from]) => norm(from) === hNorm);
        if (ali) key = ali[1];
      }
      headerMap[idx] = key || h;
    });

    // Î≥∏Î¨∏
    const data = [];
    for (let li=1; li<lines.length; li++) {
      const vals = splitSmart(lines[li]).map(v => (v || '').trim());
      const row = {};
      vals.forEach((v, i) => { const k = headerMap[i]; if (k) row[k] = v; });

      const hasMin = (row['ÌïôÎÖÑ']||row['grade']) && (row['Í≥ºÎ™©']||row['subject']) && (row['ÏßàÎ¨∏']||row['question']) && (row['Ï†ïÎãµ']||row['answer']);
      if (!hasMin) continue;

      row['ÌïôÎÖÑ']   = row['ÌïôÎÖÑ']   || row['grade']   || '';
      row['Í≥ºÎ™©']   = row['Í≥ºÎ™©']   || row['subject'] || '';
      row['ÏßàÎ¨∏']   = row['ÏßàÎ¨∏']   || row['question']|| '';
      row['Ï†ïÎãµ']   = row['Ï†ïÎãµ']   || row['answer']  || '';
      row['Î≥¥Í∏∞1']  = row['Î≥¥Í∏∞1']  || row['option1'] || '';
      row['Î≥¥Í∏∞2']  = row['Î≥¥Í∏∞2']  || row['option2'] || '';
      row['Î≥¥Í∏∞3']  = row['Î≥¥Í∏∞3']  || row['option3'] || '';
      row['Î≥¥Í∏∞4']  = row['Î≥¥Í∏∞4']  || row['option4'] || '';
      row['Ïù¥ÎØ∏ÏßÄ'] = row['Ïù¥ÎØ∏ÏßÄ'] || row['image']   || '';
      row['ÏßÄÎ¨∏ ID']= row['ÏßÄÎ¨∏ ID']|| row['ÏßÄÎ¨∏ID']   || row['passage id'] || '';
      row['ÏßÄÎ¨∏']   = row['ÏßÄÎ¨∏']   || row['passage']  || '';

      data.push(row);
    }
    return data;
  }

  // ===== ÏãúÏûë =====
  setupQuiz();
});
